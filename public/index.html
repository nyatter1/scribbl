<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Virtual Lobby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        .message-anim { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Rank Styles */
        .rank-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .rank-Owner { background: linear-gradient(to right, #f59e0b, #d97706); color: white; }
        .rank-Developer { background: linear-gradient(to right, #ef4444, #b91c1c); color: white; }
        .rank-Admin, .rank-Head-Admin { background: linear-gradient(to right, #8b5cf6, #6d28d9); color: white; }
        .rank-Moderator, .rank-Senior-Mod { background: linear-gradient(to right, #3b82f6, #1d4ed8); color: white; }
        .rank-Member { background: #334155; color: #cbd5e1; }
        .rank-BOT { background: linear-gradient(to right, #10b981, #059669); color: white; }
        
        .system-message {
            border-left: 2px solid #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        /* Console Styles */
        #terminal-overlay {
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(20px);
            font-family: 'JetBrains Mono', monospace;
        }
        .cmd-input {
            background: transparent;
            border: none;
            outline: none;
            color: #10b981;
            width: 100%;
        }
        .console-text { color: #10b981; text-shadow: 0 0 5px rgba(16, 185, 129, 0.3); }
        .console-error { color: #f87171; }

        /* Profile Modal */
        #profile-modal {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex flex-col">

    <div id="main-content-wrapper" class="flex-1 flex flex-col overflow-hidden transition-all duration-300">
        <!-- Header -->
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50 relative z-30">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-black italic tracking-tighter text-white uppercase">ChatApp</h1>
                <div class="h-4 w-px bg-slate-800"></div>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Live Lobby</p>
            </div>
                    
            <div class="flex items-center gap-4 relative">
                <div id="self-profile-trigger" onclick="toggleDropdown(event)" class="flex items-center gap-3 cursor-pointer p-1 pr-3 hover:bg-slate-800 rounded-full transition border border-transparent hover:border-slate-700">
                    <img id="header-pfp" src="" class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 object-cover">
                    <div class="flex flex-col">
                        <span id="header-username" class="text-xs font-bold text-white">@username</span>
                        <span id="header-rank" class="text-[8px] text-indigo-400 uppercase font-black tracking-tighter">Rank</span>
                    </div>
                </div>

                <!-- Profile Dropdown -->
                <div id="header-dropdown" class="hidden absolute right-0 top-full mt-2 w-56 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl py-2 z-50">
                    <div class="px-4 py-2 border-b border-slate-800 mb-1">
                        <p class="text-[10px] font-black text-slate-500 uppercase">Account</p>
                    </div>
                    <button onclick="location.href='/profile.html'" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-xs font-bold text-slate-300 transition text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        Edit Profile
                    </button>
                    <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-500/10 text-xs font-bold text-red-400 transition text-left border-t border-slate-800 mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-slate-900/30 border-r border-slate-800 flex flex-col hidden md:flex">
                <div id="user-list-container" class="flex-grow overflow-y-auto p-3 space-y-6 custom-scrollbar">
                    <div>
                        <div class="px-2 mb-3 flex justify-between items-center">
                            <span class="text-[10px] font-black uppercase text-indigo-400 tracking-widest">Online Entities</span>
                            <span id="online-count" class="text-[10px] bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded-full font-bold">0</span>
                        </div>
                        <div id="online-users" class="space-y-1"></div>
                    </div>
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="flex-1 flex flex-col bg-slate-950/50 relative">
                <div id="chat-messages" class="flex-grow overflow-y-auto p-6 space-y-6 custom-scrollbar flex flex-col"></div>

                <!-- Input Box -->
                <div class="p-4 bg-slate-900/50 border-t border-slate-800">
                    <div class="max-w-4xl mx-auto flex gap-3">
                        <input type="text" id="message-input" 
                            class="flex-1 bg-slate-900 border border-slate-800 rounded-2xl px-5 py-4 text-sm text-white focus:outline-none focus:border-indigo-500 transition-all"
                            placeholder="Type a message...">
                        <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-2xl transition font-bold text-xs uppercase tracking-widest">
                            Send
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl">
            <div class="h-24 bg-gradient-to-r from-indigo-600 to-purple-600 relative">
                <button onclick="closeProfile()" class="absolute top-4 right-4 text-white/50 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="px-6 pb-8 -mt-12 text-center">
                <img id="modal-pfp" src="" class="w-24 h-24 rounded-3xl border-4 border-slate-900 mx-auto bg-slate-800 object-cover shadow-xl">
                <h3 id="modal-username" class="mt-4 text-xl font-black text-white">@username</h3>
                <div id="modal-rank-container" class="mt-1 flex justify-center">
                    <span id="modal-rank" class="rank-badge">RANK</span>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Joined</p>
                        <p class="text-sm text-slate-200 mt-1">Recently</p>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Status</p>
                        <p class="text-sm text-emerald-400 mt-1 font-bold italic">Online</p>
                    </div>
                </div>
                <div class="mt-6 flex gap-2">
                    <button class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-tighter transition">Send Message</button>
                    <button class="px-4 bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded-xl font-bold text-xs transition">Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Console Overlay -->
    <div id="terminal-overlay" class="hidden fixed inset-0 z-50 flex flex-col p-6 overflow-hidden">
        <div class="flex items-center justify-between mb-4 border-b border-emerald-500/20 pb-2">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[10px] font-bold uppercase tracking-widest console-text">Staff Secure Terminal v2.1.0</span>
            </div>
            <div class="flex gap-4">
                <button onclick="location.href='/admin.html'" class="text-[10px] font-black text-emerald-500 hover:text-white transition uppercase tracking-widest">[Admin_Panel]</button>
                <button onclick="location.href='/profile.html'" class="text-[10px] font-black text-emerald-500 hover:text-white transition uppercase tracking-widest">[Profile]</button>
                <button onclick="closeConsole()" class="text-[10px] font-black text-emerald-500 hover:text-white transition uppercase tracking-widest">[Close_Session]</button>
            </div>
        </div>
        <div id="terminal-output" class="flex-1 overflow-y-auto custom-scrollbar text-xs space-y-2 mb-4 pr-4">
            <div class="console-text opacity-50 italic"># Encrypted Tunnel Established...</div>
            <div class="console-text italic text-yellow-500 mt-2">Staff override active. Use 'rank @user [role]' to update permissions.</div>
        </div>
        <div class="flex items-center gap-2 border-t border-emerald-500/20 pt-4">
            <span class="text-emerald-500 font-bold">$</span>
            <input type="text" id="terminal-input" class="cmd-input text-xs font-mono" placeholder="awaiting_staff_command..." autofocus>
        </div>
    </div>

    <script>
        const ALL_RANKS = [
            "Owner", "Developer", "Head-Admin", "Admin", "Senior-Mod", "Moderator", "Junior-Mod", "Trial-Mod",
            "Helper", "Staff", "Vip++", "Vip+", "Vip", "Elite", "Legend", "Titan", "Champion", "Hero", "Master",
            "Knight", "Soldier", "Warrior", "Veteran", "MVP", "Pro", "Ultra", "Expert", "Active", "Contributor",
            "Supporter", "Member", "Newbie", "Guest", "Bot", "AI", "Guardian", "Watcher", "Enforcer", "System",
            "Root", "Architect", "Designer", "Tester", "Translator", "Partner", "Media", "Famous", "Verified", 
            "Donator", "OG"
        ];

        const BOT_ENTITY = {
            username: "BOT",
            role: "BOT",
            pfp: "https://api.dicebear.com/7.x/bottts/svg?seed=ChatBot&backgroundColor=10b981",
            isOnline: true
        };

        let currentUser = {
            username: "Guest_" + Math.floor(Math.random() * 9000),
            role: "Member",
            pfp: ""
        };

        let messages = [];
        let liveUsers = [BOT_ENTITY];

        window.onload = () => {
            const saved = localStorage.getItem('chat_user');
            if (saved) currentUser = JSON.parse(saved);

            if (!liveUsers.find(u => u.username === currentUser.username)) {
                liveUsers.push({ ...currentUser, isOnline: true });
            }

            refreshUI();
            
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            document.getElementById('terminal-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') executeConsoleCommand();
            });
        };

        function refreshUI() {
            document.getElementById('header-username').innerText = `@${currentUser.username}`;
            document.getElementById('header-rank').innerText = currentUser.role;
            document.getElementById('header-pfp').src = currentUser.profilePic || currentUser.pfp || `https://ui-avatars.com/api/?name=${currentUser.username}&background=random`;
            
            renderUserList();
            renderMessages();
        }

        function toggleDropdown(e) {
            e.stopPropagation();
            document.getElementById('header-dropdown').classList.toggle('hidden');
        }

        window.onclick = () => document.getElementById('header-dropdown').classList.add('hidden');

        function logout() {
            localStorage.removeItem('chat_user');
            location.href = '/login.html';
        }

        function isStaff() {
            return currentUser.role === 'Owner' || currentUser.role === 'Developer';
        }

        function viewProfile(username) {
            const user = liveUsers.find(u => u.username === username) || (username === currentUser.username ? currentUser : null);
            if (!user) return;

            const modal = document.getElementById('profile-modal');
            document.getElementById('modal-username').innerText = `@${user.username}`;
            document.getElementById('modal-pfp').src = user.profilePic || user.pfp || `https://ui-avatars.com/api/?name=${user.username}&background=random`;
            
            const rankBadge = document.getElementById('modal-rank');
            rankBadge.innerText = user.role;
            rankBadge.className = `rank-badge rank-${user.role.replace(/ /g, '-')}`;
            
            modal.classList.remove('hidden');
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            if (text.startsWith("/")) {
                const cmd = text.toLowerCase();
                if (cmd === "/c") {
                    if (isStaff()) openConsole();
                    else {
                        messages.push({ isSystem: true, text: "ACCESS DENIED: Command reserved for Staff only." });
                        renderMessages();
                    }
                    input.value = "";
                    return;
                }
            }

            messages.push({
                username: currentUser.username,
                text: text,
                timestamp: Date.now(),
                pfp: currentUser.profilePic || currentUser.pfp,
                role: currentUser.role
            });

            input.value = "";
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => {
                if (m.isSystem) return `<div class="flex justify-center my-4 message-anim"><div class="system-message px-6 py-2 rounded-lg text-[10px] font-mono font-bold text-indigo-400 uppercase tracking-widest bg-slate-900/40 border border-white/5">${m.text}</div></div>`;

                const isSelf = m.username === currentUser.username;
                const rankClass = `rank-${m.role.replace(/ /g, '-')}`;

                return `
                    <div class="flex ${isSelf ? 'flex-row-reverse' : 'flex-row'} items-start gap-4 message-anim">
                        <img onclick="viewProfile('${m.username}')" src="${m.pfp || `https://ui-avatars.com/api/?name=${m.username}&background=random`}" class="w-10 h-10 rounded-2xl shadow-lg object-cover bg-slate-800 cursor-pointer hover:ring-2 ring-indigo-500 transition-all">
                        <div class="max-w-[70%] ${isSelf ? 'items-end' : 'items-start'} flex flex-col gap-1">
                            <div class="flex items-center gap-2 ${isSelf ? 'flex-row-reverse' : ''}">
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">${m.username}</span>
                                <span class="rank-badge ${rankClass}">${m.role}</span>
                            </div>
                            <div class="p-4 rounded-3xl ${isSelf ? 'bg-indigo-600 text-white' : 'bg-slate-900 text-slate-200 border border-slate-800'} shadow-xl">
                                <p class="text-sm leading-relaxed">${m.text}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function renderUserList() {
            const list = document.getElementById('online-users');
            document.getElementById('online-count').innerText = liveUsers.length;
            list.innerHTML = liveUsers.map(u => {
                const rankClass = `rank-${u.role.replace(/ /g, '-')}`;
                return `
                    <div onclick="viewProfile('${u.username}')" class="flex items-center gap-3 p-2 rounded-xl transition cursor-pointer hover:bg-slate-800 group">
                        <div class="relative">
                            <img src="${u.pfp || `https://ui-avatars.com/api/?name=${u.username}&background=random`}" class="w-8 h-8 rounded-lg object-cover">
                            <div class="absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-green-500 border-2 border-slate-900 rounded-full"></div>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-bold text-slate-300 truncate">${u.username}</p>
                            <span class="rank-badge ${rankClass}" style="zoom: 0.8">${u.role}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openConsole() {
            document.getElementById('terminal-overlay').classList.remove('hidden');
            document.getElementById('terminal-input').focus();
        }

        function closeConsole() {
            document.getElementById('terminal-overlay').classList.add('hidden');
        }

        function executeConsoleCommand() {
            const input = document.getElementById('terminal-input');
            const output = document.getElementById('terminal-output');
            const fullCmd = input.value.trim();
            if (!fullCmd) return;

            const args = fullCmd.split(" ");
            const cmd = args[0].toLowerCase();

            const log = (text, type = 'normal') => {
                const div = document.createElement('div');
                div.className = type === 'error' ? 'console-error' : 'console-text';
                div.innerHTML = `<span class="opacity-50 font-bold">></span> ${text}`;
                output.appendChild(div);
                output.scrollTop = output.scrollHeight;
            };

            log(fullCmd);

            if (cmd === 'rank') {
                if (args.length < 3) {
                    log('Usage: rank @username RoleName', 'error');
                } else {
                    const targetUser = args[1].replace('@', '');
                    const newRole = args[2];
                    
                    let userInList = liveUsers.find(u => u.username.toLowerCase() === targetUser.toLowerCase());
                    
                    if (!ALL_RANKS.includes(newRole)) {
                        log(`Error: '${newRole}' is not a valid rank.`, 'error');
                    } else if (!userInList && targetUser.toLowerCase() !== currentUser.username.toLowerCase()) {
                        log(`Error: User '${targetUser}' not found.`, 'error');
                    } else {
                        if (targetUser.toLowerCase() === currentUser.username.toLowerCase()) {
                            currentUser.role = newRole;
                            localStorage.setItem('chat_user', JSON.stringify(currentUser));
                        }
                        if (userInList) userInList.role = newRole;
                        
                        log(`SUCCESS: User @${targetUser} promoted to ${newRole}`);
                        refreshUI();
                    }
                }
            } else if (cmd === 'clear') {
                output.innerHTML = '';
            } else if (cmd === 'exit') {
                closeConsole();
            } else {
                log(`Command '${cmd}' not found. Type 'rank' for help.`, 'error');
            }

            input.value = "";
        }
    </script>
</body>
</html>

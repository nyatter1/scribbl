<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp - Virtual Lobby</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
                
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
                
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        
        .message-anim {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profile-banner {
            background: linear-gradient(to right, #6366f1, #a855f7);
            height: 120px;
        }
        .dropdown-glow { box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        
        #terminal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(25px);
            padding: 2rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .terminal-input {
            background: transparent;
            border: none;
            outline: none;
            color: #10b981;
            width: 100%;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex flex-col">
    <!-- Developer Terminal Overlay -->
    <div id="terminal-overlay">
        <div class="max-w-4xl mx-auto h-full flex flex-col">
            <div class="flex items-center gap-2 mb-4 border-b border-white/10 pb-2">
                <span class="text-red-500 text-xs">●</span>
                <span class="text-yellow-500 text-xs">●</span>
                <span class="text-green-500 text-xs">●</span>
                <span class="ml-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest">Dev_Kernel :: Access_Level_Admin</span>
            </div>
            <div id="terminal-output" class="flex-1 overflow-y-auto text-sm space-y-2 custom-scrollbar text-slate-400">
                <p class="text-emerald-500">Developer Authenticated. System Ready.</p>
                <p>Type <span class="text-white">/help</span> for commands.</p>
            </div>
            <div class="flex items-center gap-2 mt-4 text-emerald-500 border-t border-white/10 pt-4">
                <span>dev@chatapp:~#</span>
                <input type="text" id="terminal-command-input" class="terminal-input" autofocus autocomplete="off">
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/50 relative z-30">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black italic tracking-tighter text-white uppercase">ChatApp</h1>
            <div class="h-4 w-px bg-slate-800"></div>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Live Lobby</p>
        </div>
                
        <div class="flex items-center gap-4 relative">
            <div id="self-profile-trigger" onclick="toggleDropdown(event)" class="flex items-center gap-3 cursor-pointer p-1 pr-3 hover:bg-slate-800 rounded-full transition border border-transparent hover:border-slate-700">
                <img id="header-pfp" src="" class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 object-cover">
                <div class="flex flex-col">
                    <span id="header-username" class="text-xs font-bold text-white">@username</span>
                    <span id="header-rank" class="text-[8px] text-indigo-400 uppercase font-black">Rank</span>
                </div>
            </div>

            <!-- Profile Dropdown -->
            <div id="header-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl dropdown-glow py-2 z-50">
                <!-- Navigates to profile.html -->
                <a href="/profile.html" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-800 text-xs font-bold text-slate-300 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    My Profile
                </a>
                                
                <div id="admin-panel-btn" class="hidden border-t border-slate-800 mt-1">
                    <!-- Navigates to admin.html -->
                    <button onclick="window.location.href='/admin.html'" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-indigo-500/10 text-xs font-bold text-indigo-400 transition text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        Admin Panel
                    </button>
                </div>

                <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-500/10 text-xs font-bold text-red-400 transition text-left border-t border-slate-800 mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900/30 border-r border-slate-800 flex flex-col hidden md:flex">
            <div id="user-list-container" class="flex-grow overflow-y-auto p-3 space-y-6 custom-scrollbar">
                <div>
                    <div class="px-2 mb-3 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase text-indigo-400 tracking-widest">Active Users</span>
                        <span id="online-count" class="text-[10px] bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded-full font-bold">0</span>
                    </div>
                    <div id="online-users" class="space-y-1"></div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-slate-950/50 relative">
            <div id="chat-messages" class="flex-grow overflow-y-auto p-6 space-y-6 custom-scrollbar flex flex-col">
                <!-- Live Messages -->
            </div>

            <!-- Input Box -->
            <div class="p-4 bg-slate-900/50 border-t border-slate-800">
                <div class="max-w-4xl mx-auto flex gap-3">
                    <input type="text" id="message-input" 
                        class="flex-1 bg-slate-900 border border-slate-800 rounded-2xl px-5 py-4 text-sm text-white focus:outline-none focus:border-indigo-500 transition-all"
                        placeholder="Push message to terminal...">
                    <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-2xl transition font-bold text-xs uppercase tracking-widest">
                        Send
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeProfile()"></div>
        <div class="relative w-full max-w-md bg-slate-900 rounded-[2.5rem] overflow-hidden border border-slate-800 shadow-2xl message-anim">
            <div class="profile-banner relative">
                <button onclick="closeProfile()" class="absolute top-4 right-4 p-2 bg-black/20 hover:bg-black/40 rounded-full text-white backdrop-blur-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="px-8 pb-8">
                <div class="relative -mt-12 mb-4">
                    <img id="view-pfp" src="" class="w-24 h-24 rounded-[2rem] border-4 border-slate-900 bg-slate-800 object-cover">
                </div>
                <h2 id="view-username" class="text-2xl font-black text-white italic tracking-tighter uppercase mb-1">@username</h2>
                <p id="view-role" class="text-[10px] text-indigo-400 font-bold uppercase tracking-[0.2em] mb-4">Role</p>
                <div class="bg-slate-950/50 rounded-2xl p-4 border border-slate-800/50">
                    <p id="view-bio" class="text-sm text-slate-400 leading-relaxed italic">No bio recorded.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- DATA ---
        const ALL_RANKS = [
            "Member", "Active Member", "Veteran", "Trustee", "Elite", "Legend", "Mythic", "Immortal",
            "VIP", "VIP+", "SuperVIP", "MVP", "MVP+", "Ultra", "Sovereign", "Celestial", "Aether",
            "Supporter", "Donor", "Sponsor", "Patron", "Benefactor", "Contributor", "Partner", "Affiliate",
            "Novice", "Expert", "Master", "Grandmaster", "Prestige I", "Prestige II", "Prestige III", "Prestige IV", "Prestige V",
            "Beta Tester", "OG", "Early Bird", "Explorer", "Seeker", "Wanderer",
            "Site-Helper", "Trial Mod", "Mod", "Senior Mod", "Admin", "Super Admin", 
            "System Admin", "Network Admin", "Lead Admin", "Manager", "Community Manager",
            "Staff Manager", "Developer", "Head Developer", "Lead Developer", "Owner", "Creator"
        ];

        const ADMIN_ROLES = ["Admin", "Super Admin", "Owner", "Developer", "Manager"];
        
        let socket;
        let currentUser = null;
        let messages = [];
        let liveUsers = [];

        window.onload = () => {
            const saved = localStorage.getItem('chat_user');
            if (!saved) {
                window.location.href = '/login.html';
                return;
            }
            currentUser = JSON.parse(saved);

            refreshUI();
            initSocket();
            
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            document.getElementById('terminal-command-input').addEventListener('keypress', handleTerminalCommand);
        };

        function initSocket() {
            socket = io();
            socket.emit('join', currentUser);

            socket.on('init_data', (data) => {
                messages = data.history;
                liveUsers = data.users;
                renderMessages();
                renderUserList();
            });

            socket.on('new_message', (msg) => {
                messages.push(msg);
                renderMessages();
            });

            socket.on('user_joined', (user) => {
                if (!liveUsers.find(u => u.username === user.username)) {
                    liveUsers.push(user);
                    renderUserList();
                }
            });

            socket.on('user_left', (socketId) => {
                liveUsers = liveUsers.filter(u => u.socketId !== socketId);
                renderUserList();
            });

            socket.on('user_updated', (updatedUser) => {
                if (updatedUser.username === currentUser.username) {
                    currentUser = { ...currentUser, ...updatedUser };
                    localStorage.setItem('chat_user', JSON.stringify(currentUser));
                    refreshUI();
                }
                liveUsers = liveUsers.map(u => u.username === updatedUser.username ? { ...u, ...updatedUser } : u);
                renderUserList();
            });

            socket.on('user_kicked', (data) => {
                if (data.username === currentUser.username) {
                    localStorage.removeItem('chat_user');
                    window.location.href = '/login.html';
                }
            });
            
            socket.on('clear_chat', () => {
                messages = [];
                renderMessages();
            });
        }

        function refreshUI() {
            document.getElementById('header-username').innerText = `@${currentUser.username}`;
            document.getElementById('header-rank').innerText = currentUser.role;
            document.getElementById('header-pfp').src = currentUser.pfp || `https://api.dicebear.com/7.x/identicon/svg?seed=${currentUser.username}`;

            const adminBtn = document.getElementById('admin-panel-btn');
            if (ADMIN_ROLES.includes(currentUser.role)) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }
        }

        function toggleDropdown(e) {
            e.stopPropagation();
            document.getElementById('header-dropdown').classList.toggle('hidden');
        }

        window.onclick = () => {
            document.getElementById('header-dropdown').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('chat_user');
            window.location.href = '/login.html';
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            if (!input.value.trim()) return;

            socket.emit('send_message', { text: input.value });
            input.value = "";
        }

        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => `
                <div class="flex ${m.username === currentUser.username ? 'flex-row-reverse' : 'flex-row'} items-start gap-4 message-anim">
                    <img onclick="openProfile('${m.username}')" src="${m.pfp || `https://api.dicebear.com/7.x/identicon/svg?seed=${m.username}`}" class="w-10 h-10 rounded-2xl cursor-pointer hover:scale-105 transition shadow-lg object-cover bg-slate-800">
                    <div class="max-w-[70%] ${m.username === currentUser.username ? 'items-end' : 'items-start'} flex flex-col gap-1">
                        <div class="flex items-center gap-2 ${m.username === currentUser.username ? 'flex-row-reverse' : ''}">
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">${m.username}</span>
                            <span class="text-[8px] bg-slate-800 text-indigo-400 px-2 py-0.5 rounded font-bold">${m.role}</span>
                        </div>
                        <div class="p-4 rounded-3xl ${m.username === currentUser.username ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-900 text-slate-200 rounded-tl-none border border-slate-800'} shadow-xl">
                            <p class="text-sm leading-relaxed">${m.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function renderUserList() {
            const list = document.getElementById('online-users');
            document.getElementById('online-count').innerText = liveUsers.length;

            list.innerHTML = liveUsers.map(u => `
                <div onclick="openProfile('${u.username}')" class="flex items-center gap-3 p-2 hover:bg-slate-800/50 rounded-xl cursor-pointer transition group">
                    <div class="relative">
                        <img src="${u.pfp || `https://api.dicebear.com/7.x/identicon/svg?seed=${u.username}`}" class="w-8 h-8 rounded-lg object-cover">
                        <div class="absolute -bottom-1 -right-1 w-2.5 h-2.5 bg-green-500 border-2 border-slate-900 rounded-full"></div>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-slate-300 truncate group-hover:text-white">${u.username}</p>
                        <p class="text-[9px] text-indigo-400 font-black uppercase tracking-widest">${u.role}</p>
                    </div>
                </div>
            `).join('');
        }

        function openProfile(username) {
            let user = liveUsers.find(u => u.username === username);
            if (!user) return;

            document.getElementById('view-pfp').src = user.pfp || `https://api.dicebear.com/7.x/identicon/svg?seed=${user.username}`;
            document.getElementById('view-username').innerText = `@${user.username}`;
            document.getElementById('view-role').innerText = user.role;
            document.getElementById('view-bio').innerText = user.bio || "No bio recorded.";
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        let isTerminalOpen = false;

        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && e.key === "Delete") {
                e.preventDefault();
                if (currentUser.role === "Developer") {
                    toggleTerminal();
                }
            }
            if (e.key === "Escape" && isTerminalOpen) toggleTerminal();
        });

        function toggleTerminal() {
            const terminal = document.getElementById('terminal-overlay');
            isTerminalOpen = !isTerminalOpen;
            terminal.style.display = isTerminalOpen ? 'block' : 'none';
            if (isTerminalOpen) {
                setTimeout(() => document.getElementById('terminal-command-input').focus(), 50);
            }
        }

        function terminalPrint(text, color = "text-slate-400") {
            const output = document.getElementById('terminal-output');
            const p = document.createElement('p');
            p.className = color;
            p.innerText = text;
            output.appendChild(p);
            output.scrollTop = output.scrollHeight;
        }

        function handleTerminalCommand(e) {
            if (e.key !== 'Enter') return;
            const input = e.target;
            const cmdText = input.value.trim();
            input.value = "";

            if (!cmdText) return;

            terminalPrint(`dev@chatapp:~# ${cmdText}`, "text-white");
            const parts = cmdText.split(" ");
            const command = parts[0].toLowerCase();
            const args = parts.slice(1);

            switch(command) {
                case '/help':
                    terminalPrint("Developer Commands:");
                    terminalPrint("/clear - Permanently delete chat history.");
                    terminalPrint("/rank [user] [rank] - Override user authority level.");
                    terminalPrint("/listranks - Show rank index.");
                    break;
                case '/clear':
                    socket.emit('dev_command', { command: 'clear' });
                    terminalPrint("Kernel logs purged. Messages cleared.", "text-emerald-500");
                    break;
                case '/rank':
                    if (args.length < 2) {
                        terminalPrint("Usage: /rank [username] [rank]", "text-red-500");
                    } else {
                        const targetName = args[0];
                        const newRankName = args.slice(1).join(" ");
                        const validRank = ALL_RANKS.find(r => r.toLowerCase() === newRankName.toLowerCase());

                        if (!validRank) {
                            terminalPrint("Invalid rank code.", "text-red-500");
                            break;
                        }
                        
                        // Hit the admin API
                        fetch('/api/admin/rank', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                adminUsername: currentUser.username,
                                targetUsername: targetName,
                                newRole: validRank
                            })
                        }).then(r => r.json()).then(res => {
                            if(res.success) terminalPrint(`Authority updated for ${targetName} to ${validRank}`, "text-emerald-500");
                            else terminalPrint(res.message, "text-red-500");
                        });
                    }
                    break;
                case '/listranks':
                    terminalPrint(ALL_RANKS.join(", "), "text-indigo-400");
                    break;
                default:
                    terminalPrint(`Unauthorized or unknown: ${command}`, "text-red-500");
            }
        }
    </script>
</body>
</html>
